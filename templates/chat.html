<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>チャットルーム</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f0f0f0;
      padding: 20px;
      margin: 0;
    }

    #container {
      display: flex;
      height: 90vh;
    }

    #chat {
      border: 1px solid #ccc;
      background: #fff;
      padding: 10px;
      height: 400px;
      overflow-y: scroll;
    }

    .msg {
      max-width: 60%;
      margin: 5px;
      padding: 8px;
      border-radius: 10px;
      clear: both;
      position: relative;
    }

    .left {
      background-color: #eee;
      float: left;
    }

    .right {
      background-color: #acf;
      float: right;
      text-align: right;
    }

    /* メッセージ本体の見た目 */
    .msg-content {
      display: flex;
      flex-direction: column;
    }

    /* 名前とアイコンを横並び */
    .header {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    /* 自分のメッセージ（右寄せ）では名前＋アイコンを右寄せに */
    .right .header {
      flex-direction: row-reverse;
      justify-content: flex-end;
    }

    /* テキスト本文 */
    .text {
      margin-top: 4px;
      word-break: break-word;
    }

    /* メタ情報（時間） */
    .meta {
      font-size: 0.8em;
      color: #555;
      margin-top: 3px;
    }

    /* アイコン画像 */
    .icon {
      border-radius: 50%;
      width: 24px;
      height: 24px;
    }

    /* メンバー一覧 */
    #sidebar {
      flex: 1;
      padding: 10px;
      border-left: 1px solid #ccc;
      background-color: #fff;
      overflow-y: auto;
    }

    #sidebar h3 {
      margin-top: 0;
    }

    #sidebar ul {
      list-style-type: none;
      padding: 0;
    }

    #sidebar li {
      padding: 5px 0;
      border-bottom: 1px solid #ddd;
    }
  </style>
</head>
<body>
  <h2>ようこそ {{ user }} さん！</h2>

  <div id="container">
    <!-- 左：チャット -->
    <div id="main">
      <div id="chat"></div>
      <input id="text" placeholder="メッセージ" style="width:70%;">
      <button onclick="send()">送信</button>
      <input type="file" id="fileInput">
      <button onclick="uploadFile()">ファイル送信</button>

    </div>

    <!-- 右：メンバー一覧 -->
    <div id="sidebar">
      <h3>メンバー</h3>
        <ul>
        {% for member in members %}
        <li>
          {% if member.icon %}
            <img src="{{ url_for('serve_icon', filename=member.icon) }}" alt="icon" height="32">
          {% else %}
            <img src="{{ url_for('static', filename='default.jpeg') }}" alt="icon" height="32">
          {% endif %}
          {{ member.name }}
          </li>
          {% endfor %}
        </ul>
    </div>
  </div>

  <script>
  const userName = "{{ user }}";
  const userEmail = "{{ email }}";

  async function loadMessages() {
    const res = await fetch("/messages");
    const data = await res.json();
    const chat = document.getElementById("chat");
    chat.innerHTML = "";

    data.forEach(msg => {
      const isMine = msg.email === userEmail;
      const side = isMine ? "right" : "left";
      const bubble = document.createElement("div");
      bubble.className = `msg ${side}`;

      // アイコン画像のURLを作る（ファイルが存在しない場合はデフォルトにするなど応用可）
      //const iconUrl = `/icons/${msg.icon || 'default.jpeg'}`;
      const iconUrl = msg.icon ? '/icons/' + msg.icon : '/static/default.jpeg';
      //const iconUrl = iconFilename;
      bubble.innerHTML = `
        <div class="msg-content">
          <div class="bubble">
            <div class="header">
              <img src="${iconUrl}" class="icon" height="24" />
              <strong>${msg.name}</strong>
            </div>
            <div class="text">
              ${
                msg.text.startsWith("[ファイル] ")
                  ? `<a href="/files/${msg.text.replace("[ファイル] ", "")}" target="_blank">${msg.text.replace("[ファイル] ", "")}</a>`
                  : msg.text
              }
            </div>
            <div class="meta">${msg.time}</div>
          </div>
        </div>
      `;

      bubble.style.backgroundColor = isMine ? "#acf" : "#eee";
      bubble.style.color = isMine ? "#000" : "#333";
      bubble.style.borderRadius = "10px";
      bubble.style.padding = "8px";
      bubble.style.margin = "5px";
      bubble.style.clear = "both";
      bubble.style.position = "relative";

  chat.appendChild(bubble);
});

    chat.scrollTop = chat.scrollHeight;
  }

  async function send() {
    const text = document.getElementById("text").value;
    if (!text.trim()) return;

    await fetch("/send", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name: userName, text })
    });

    document.getElementById("text").value = "";
    loadMessages();
  }
  async function uploadFile() {
  const fileInput = document.getElementById("fileInput");
  const file = fileInput.files[0];
  if (!file) return alert("ファイルを選んでください");

  const formData = new FormData();
  formData.append("file", file);

  const res = await fetch("/upload", {
    method: "POST",
    body: formData
  });

  if (res.ok) {
    document.getElementById("fileInput").value = "";  // 初期化
    loadMessages();  // チャット更新
  } else {
    alert("アップロード失敗");
  }
  }

  setInterval(loadMessages, 1000);
  loadMessages();
  </script>
</body>
</html>
