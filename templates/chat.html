<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>チャットルーム</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
    }

    header {
      background-color: #2196f3;
      color: white;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #container {
      display: flex;
      height: calc(100vh - 60px);
    }

    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 10px;
    }

    #chat {
      flex: 1;
      overflow-y: auto;
      background-color: white;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 10px;
    }

    #inputArea {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    #inputArea input[type="text"] {
      flex: 1;
      padding: 10px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }

    .file-btn {
      background-color: #eee;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
    }

    #sendBtn {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 4px;
      cursor: pointer;
    }

    #sendBtn:hover {
      background-color: #45a049;
    }

    #fileSendBtn {
      background-color: #607d8b;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 4px;
      cursor: pointer;
    }

    #sidebar {
      width: 220px;
      background-color: #e0e0e0;
      padding: 10px;
      border-left: 1px solid #ccc;
      overflow-y: auto;
    }

    #sidebar ul {
      list-style: none;
      padding: 0;
    }

    #sidebar li {
      margin: 10px 0;
      display: flex;
      align-items: center;
    }

    .icon {
      border-radius: 50%;
      margin-right: 8px;
    }

    .modal {
      position: fixed;
      top: 10%;
      left: 50%;
      transform: translateX(-50%);
      background-color: white;
      border: 1px solid #ccc;
      padding: 20px;
      z-index: 1000;
      width: 300px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    .modal button {
      margin-right: 5px;
      margin-top: 10px;
    }

    #settingsBtn {
      background-color: transparent;
      border: none;
      font-size: 24px;
      color: white;
      cursor: pointer;
    }

    #settingsBtn:hover {
      opacity: 0.8;
    }
  </style>
</head>
<body>
  <header>
    <h2 id="welcomeMessage">ようこそ {{ user }} さん！</h2>
    <button id="settingsBtn">⚙️</button>
  </header>

  <div id="container">
    <div id="main">
      <div id="chat"></div>

      <div id="inputArea">
        <input id="text" placeholder="メッセージを入力..." />
        <label for="fileInput" class="file-btn">ファイルを追加</label>
        <input type="file" id="fileInput" style="display: none;" />
        <button id="sendBtn" onclick="send()">送信</button>
        <button id="fileSendBtn" onclick="uploadFile()">ファイル送信</button>
      </div>
    </div>

    <div id="sidebar">
      <h3>メンバー</h3>
      <ul>
        {% for member in members %}
        <li>
          <img src="{{ url_for('serve_icon', filename=member.icon) if member.icon else url_for('static', filename='default.jpeg') }}" height="32" class="icon">
          {{ member.name }}
        </li>
        {% endfor %}
      </ul>
    </div>
  </div>

  <div id="settingsModal" class="modal" style="display: none;">
    <h3>プロフィール設定</h3>
    <label>表示名:<br>
      <input type="text" id="displayNameInput">
    </label><br><br>
    <label>現在のアイコン:</label><br>
    <img id="currentIconPreview" src="/static/default.jpeg" alt="現在のアイコン" height="64"><br><br>
    <label for="icon">アイコン画像 (指定しない場合は今のアイコンが使用されます):</label><br>
    <input type="file" name="icon" accept="image/*" id="iconInput"><br><br>
    <button id="logout" type="button">ログアウト</button>
    <button id="saveSettings" type="button">保存</button>
    <button id="closeSettings" type="button">キャンセル</button>
  </div>

  <script>
    async function loadMessages() {
      const res = await fetch("/messages");
      const messages = await res.json();
      const chat = document.getElementById("chat");
      chat.innerHTML = "";
      for (const msg of messages) {
        const div = document.createElement("div");
        div.innerHTML = `<strong>${msg.user}</strong>: ${msg.text} ${msg.filename ? `<a href="/uploads/${msg.filename}" target="_blank">[ファイル]</a>` : ""}`;
        chat.appendChild(div);
      }
      chat.scrollTop = chat.scrollHeight;
    }

    async function send() {
      const textInput = document.getElementById("text");
      const text = textInput.value;
      if (!text.trim()) return;
      await fetch("/send", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text })
      });
      textInput.value = "";
      loadMessages();
    }

    async function uploadFile() {
      const fileInput = document.getElementById("fileInput");
      if (fileInput.files.length === 0) return;

      const formData = new FormData();
      formData.append("file", fileInput.files[0]);

      await fetch("/upload", {
        method: "POST",
        body: formData
      });

      fileInput.value = "";
      loadMessages();
    }

    // モーダル開閉処理
    document.getElementById("settingsBtn").addEventListener("click", () => {
      document.getElementById("settingsModal").style.display = "block";
    });

    document.getElementById("closeSettings").addEventListener("click", () => {
      document.getElementById("settingsModal").style.display = "none";
    });

    document.getElementById("logout").addEventListener("click", () => {
      window.location.href = "/logout";
    });

    document.getElementById("saveSettings").addEventListener("click", async () => {
      const displayName = document.getElementById("displayNameInput").value;
      const iconFile = document.getElementById("iconInput").files[0];
      const formData = new FormData();
      formData.append("display_name", displayName);
      if (iconFile) {
        formData.append("icon", iconFile);
      }
      await fetch("/update_profile", {
        method: "POST",
        body: formData,
      });
      document.getElementById("settingsModal").style.display = "none";
      location.reload();
    });

    // 最初の読み込み・定期更新
    setInterval(loadMessages, 1000);
    loadMessages();
  </script>
</body>
</html>
