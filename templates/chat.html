<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>チャットルーム</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f0f0f0;
      padding: 20px;
      margin: 0;
    }

    #container {
      display: flex;
      height: 90vh;
    }

    /* チャット本体 */
    #main {
      flex: 3;
      padding: 10px;
    }

    #chat {
      border: 1px solid #ccc;
      background: #fff;
      padding: 10px;
      height: 400px;
      overflow-y: scroll;
    }

    .msg {
      max-width: 60%;
      margin: 5px;
      padding: 8px;
      border-radius: 10px;
      clear: both;
      position: relative;
    }

    .left {
      background-color: #eee;
      float: left;
    }

    .right {
      background-color: #acf;
      float: right;
    }

    .meta {
      font-size: 0.8em;
      color: #555;
      margin-top: 3px;
    }

    /* メンバー一覧 */
    #sidebar {
      flex: 1;
      padding: 10px;
      border-left: 1px solid #ccc;
      background-color: #fff;
      overflow-y: auto;
    }

    #sidebar h3 {
      margin-top: 0;
    }

    #sidebar ul {
      list-style-type: none;
      padding: 0;
    }

    #sidebar li {
      padding: 5px 0;
      border-bottom: 1px solid #ddd;
    }
  </style>
</head>
<body>
  <h2>ようこそ {{ user }} さん！</h2>

  <div id="container">
    <!-- 左：チャット -->
    <div id="main">
      <div id="chat"></div>
      <input id="text" placeholder="メッセージ" style="width:70%;">
      <button onclick="send()">送信</button>
      <input type="file" id="fileInput">
      <button onclick="uploadFile()">ファイル送信</button>

    </div>

    <!-- 右：メンバー一覧 -->
    <div id="sidebar">
      <h3>メンバー</h3>
        <ul>
        {% for member in members %}
        <li>
          {% if member.icon %}
            <img src="{{ url_for('serve_icon', filename=member.icon) }}" alt="icon" height="32">
          {% else %}
            <img src="{{ url_for('static', filename='default_icon.jpeg
          ') }}" alt="icon" height="32">
          {% endif %}
          {{ member.name }}
          </li>
          {% endfor %}
        </ul>
    </div>
  </div>

  <script>
  const userName = "{{ user }}";
  const userEmail = "{{ email }}";

  async function loadMessages() {
    const res = await fetch("/messages");
    const data = await res.json();
    const chat = document.getElementById("chat");
    chat.innerHTML = "";

    data.forEach(msg => {
      const isMine = msg.email === userEmail;
      const side = isMine ? "right" : "left";
      const bubble = document.createElement("div");
      bubble.className = `msg ${side}`;

      // アイコン画像のURLを作る（ファイルが存在しない場合はデフォルトにするなど応用可）
      const iconUrl = `/icons/${msg.icon || 'default.jpeg'}`;
      bubble.innerHTML = `
        <div class="msg-content">
          <img src="${iconUrl}" class="icon-img" height="32" />
          <div class="bubble">
        <strong>${msg.name}</strong><br>
        ${msg.text.startsWith("[ファイル] ")
          ? `<a href="/files/${msg.text.replace("[ファイル] ", "")}" target="_blank">${msg.text.replace("[ファイル] ", "")}</a>`
          : msg.text}
        <div class="meta">${msg.time}</div>
      </div>
    </div>
  `;

  chat.appendChild(bubble);
});

    chat.scrollTop = chat.scrollHeight;
  }

  async function send() {
    const text = document.getElementById("text").value;
    if (!text.trim()) return;

    await fetch("/send", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name: userName, text })
    });

    document.getElementById("text").value = "";
    loadMessages();
  }
  async function uploadFile() {
  const fileInput = document.getElementById("fileInput");
  const file = fileInput.files[0];
  if (!file) return alert("ファイルを選んでください");

  const formData = new FormData();
  formData.append("file", file);

  const res = await fetch("/upload", {
    method: "POST",
    body: formData
  });

  if (res.ok) {
    document.getElementById("fileInput").value = "";  // 初期化
    loadMessages();  // チャット更新
  } else {
    alert("アップロード失敗");
  }
  }

  setInterval(loadMessages, 1000);
  loadMessages();
  </script>
</body>
</html>
