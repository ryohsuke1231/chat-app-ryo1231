<!DOCTYPE html>
<html lang="ja">
    <head>
      <meta charset="UTF-8" />
      <title>アプリパスワード認証</title>
      <link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      />
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link href="https://fonts.googleapis.com/css2?family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap" rel="stylesheet">
      <style>
        body {
          font-family: "Helvetica Neue", sans-serif;
          background: #f0f2f5;
          display: flex;
          justify-content: center;
          align-items: center;
          height: 100vh;
          margin: 0;
        }

        .login-box {
          background: white;
          padding: 40px;
          border-radius: 12px;
          box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
          width: 300px;
          text-align: center;
        }

        .login-box h2 {
          margin-bottom: 16px;
        }

        .login-box p {
          margin-bottom: 24px;
          color: #555;
          font-size: 14px;
        }

        .login-box input {
          width: 100%;
          padding: 12px;
          margin: 8px 0;
          border: 1px solid #ccc;
          border-radius: 8px;
          font-size: 14px;
        }

        .login-box button {
          width: 100%;
          padding: 12px;
          margin-top: 16px;
          background-color: #4caf50;
          border: none;
          color: white;
          font-size: 16px;
          border-radius: 8px;
          cursor: pointer;
          transition: background-color 0.3s ease;
        }

        .login-box button:hover {
          background-color: #45a049;
        }

        .error {
          color: red;
          margin-top: 10px;
          font-size: 14px;
        }

        .lotate-and-flip {
          transform-style: preserve-3d;  /* 3D変換を有効にする */
          animation: flip3D 1s linear infinite;
        }
        @keyframes rotate {
          from {
            transform: rotate(0deg);
          }
          to {
            transform: rotate(360deg);
          }
        }

        @keyframes flip3D {
            from {
                transform: rotateY(0deg);  /* 初期状態: 正面 */
            }
            50% {
                transform: rotateY(180deg);  /* 半回転: 裏面 */
            }
            to {
                transform: rotateY(0deg);  /* 元に戻す: 正面 */
            }
        }

        @keyframes flip {
          from {
            transform: scaleX(1);
          }
          50% {
            transform: scaleX(-1);
          }
          to {
            transform: scaleX(1);
          }
        }

        .ubuntu {
          font-family: "Ubuntu", sans-serif;
          font-weight: 400;
          font-style: normal;
        }
        
      </style>
    </head>
    <body>
      <div class="login-box">
        <h1 class="ubuntu">chat-app-ryo</h1>
        <i class="fa-solid fa-comment-dots lotate-and-flip" style="font-size: 100px;"></i>
        <h2>アプリアクセス認証</h2>
        <p>このアプリにアクセスするにはパスワードが必要です</p>

        {% if error %}
        <script>
          alert("{{ error }}");
          window.onload = function () {
            document.getElementById("password_display").value = "";
          };
        </script>
        {% endif %}

        <form method="POST">
          <!-- 表示用パスワード -->
          <input
            id="password_display"
            type="text"
            placeholder="アプリパスワード"
            autocomplete="off"
            autocapitalize="off"
            inputmode="latin"
            required
          />

          <!-- 実際に送信されるパスワード -->
          <input
            id="password_real"
            name="app_password"
            type="password"
            style="display: none"
            required
          />

          <button type="submit">認証</button>
        </form>
      </div>
    </body>
    <script>
        function setupMaskedInput(displayId, realId) {
            const displayInput = document.getElementById(displayId);
            const realInput = document.getElementById(realId);
            let timeoutId;

            displayInput.addEventListener("input", () => {
                const newText = displayInput.value;
                const oldText = realInput.value;

                if (newText.length > oldText.length) {
                    // 追加された文字だけ加える
                    const addedChar = newText.slice(-1);
                    realInput.value += addedChar;
                } else {
                    // 削除された場合
                    realInput.value = realInput.value.slice(0, newText.length);
                }

                // マスク表示：最後の1文字だけ表示
                const maskLength = Math.max(0, realInput.value.length - 1);
                const masked =
                    "●".repeat(maskLength) +
                    (realInput.value.slice(-1) || "");
                displayInput.value = masked;

                if (timeoutId) clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    displayInput.value = "●".repeat(Math.max(0, realInput.value.length));
                }, 1000);
            });

            // フォーカス外れたときは完全にマスク
            displayInput.addEventListener("blur", () => {
                displayInput.value = "●".repeat(Math.max(0, realInput.value.length));
                if (timeoutId) clearTimeout(timeoutId);
            });
        }

        // パスワード入力欄をマスク設定
        setupMaskedInput("password_display", "password_real");

      const device_type = {{ device_type | tojson }};
      if (device_type === "mobile") {
        alert("このアプリはPC用に設計されているため、モバイル端末で利用すると見づらい、操作しにくい場合がございます。");
      }
    </script>
</body>
</html>
