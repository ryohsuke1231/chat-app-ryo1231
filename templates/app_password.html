<!DOCTYPE html>
<html lang="ja">
    <head>
      <meta charset="UTF-8" />
      <title>アプリパスワード認証</title>
      <style>
        body {
          font-family: "Helvetica Neue", sans-serif;
          background: #f0f2f5;
          display: flex;
          justify-content: center;
          align-items: center;
          height: 100vh;
          margin: 0;
        }

        .login-box {
          background: white;
          padding: 40px;
          border-radius: 12px;
          box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
          width: 300px;
          text-align: center;
        }

        .login-box h2 {
          margin-bottom: 16px;
        }

        .login-box p {
          margin-bottom: 24px;
          color: #555;
          font-size: 14px;
        }

        .login-box input {
          width: 100%;
          padding: 12px;
          margin: 8px 0;
          border: 1px solid #ccc;
          border-radius: 8px;
          font-size: 14px;
        }

        .login-box button {
          width: 100%;
          padding: 12px;
          margin-top: 16px;
          background-color: #4caf50;
          border: none;
          color: white;
          font-size: 16px;
          border-radius: 8px;
          cursor: pointer;
          transition: background-color 0.3s ease;
        }

        .login-box button:hover {
          background-color: #45a049;
        }

        .error {
          color: red;
          margin-top: 10px;
          font-size: 14px;
        }
      </style>
    </head>
    <body>
      <div class="login-box">
        <h2>アプリアクセス認証</h2>
        <p>このアプリにアクセスするにはパスワードが必要です</p>

        {% if error %}
        <script>
          alert("{{ error }}");
          window.onload = function () {
            document.getElementById("password_display").value = "";
          };
        </script>
        {% endif %}

        <form method="POST">
          <!-- 表示用パスワード -->
          <input
            id="password_display"
            type="text"
            placeholder="アプリパスワード"
            autocomplete="off"
            autocapitalize="off"
            inputmode="latin"
            required
          />

          <!-- 実際に送信されるパスワード -->
          <input
            id="password_real"
            name="app_password"
            type="password"
            style="display: none"
            required
          />

          <button type="submit">認証</button>
        </form>
      </div>
    </body>
    <script>
        function setupMaskedInput(displayId, realId) {
            const displayInput = document.getElementById(displayId);
            const realInput = document.getElementById(realId);
            let timeoutId;

            displayInput.addEventListener("input", () => {
                const newText = displayInput.value;
                const oldText = realInput.value;

                if (newText.length > oldText.length) {
                    // 追加された文字だけ加える
                    const addedChar = newText.slice(-1);
                    realInput.value += addedChar;
                } else {
                    // 削除された場合
                    realInput.value = realInput.value.slice(0, newText.length);
                }

                // マスク表示：最後の1文字だけ表示
                const maskLength = Math.max(0, realInput.value.length - 1);
                const masked =
                    "●".repeat(maskLength) +
                    (realInput.value.slice(-1) || "");
                displayInput.value = masked;

                if (timeoutId) clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    displayInput.value = "●".repeat(Math.max(0, realInput.value.length));
                }, 1000);
            });

            // フォーカス外れたときは完全にマスク
            displayInput.addEventListener("blur", () => {
                displayInput.value = "●".repeat(Math.max(0, realInput.value.length));
                if (timeoutId) clearTimeout(timeoutId);
            });
        }

        // パスワード入力欄をマスク設定
        setupMaskedInput("password_display", "password_real");
    </script>
</body>
</html>
